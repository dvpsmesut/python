node("jenkins-slave") {

	stage('Clone Code') {
			
            checkout scm 
    	   		
            sh "date | md5sum | cut -c-8 > ${env.WORKSPACE}/tag.txt"
            imageTag = readFile("${env.WORKSPACE}/tag.txt").trim()  
            
    }

    stage('Build and Push Docker Image') {

        def dockerfile = 'Dockerfile.dev'
        def customImage = docker.build("${env.JOB_BASE_NAME}", "-f ./k8s/${dockerfile} .")

        withDockerRegistry(credentialsId: 'hub-docker-com') {
          customImage.push("${imageTag}")
        }
    }

    stage('Deploy on k8s') {

        sh "sed -i \"s/_imageTag/${imageTag}/g\" ${env.WORKSPACE}/k8s/app-deployment.yaml"
        sh "kubectl apply -f ${env.WORKSPACE}/k8s/app-deployment.yaml"

    }

}

